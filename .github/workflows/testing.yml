name: Testing ðŸ§ª

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  
  unit-testing:
    runs-on: ubuntu-latest
    name: Unit Testing
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Build
      uses: ./.github/workflows/build-action

    - name: Test
      run: dotnet test --verbosity normal --filter "FullyQualifiedName~UnitTests" --no-build

  integration-testing:
    runs-on: ubuntu-latest
    name: Integration Testing
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Build
      uses: ./.github/workflows/build-action

    - name: Test
      run: dotnet test --verbosity normal --filter "FullyQualifiedName~IntegrationTests" --no-build
    
  end-to-end-testing:
    runs-on: ubuntu-latest
    name: End To End Testing
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
    
    - name: Add JWT Settings Secret Key
      run: |
        sed -i "s/\"SecretKey\": \"\"/\"SecretKey\": \"${{ secrets.SUPER_SECRET_JWT_KEY }}\"/g" ./src/ConsiliumTempus.Api/appsettings.json

    - name: Copy Environment File (.env)
      run: cp .env.dev .env

    - name: Run Docker Containers
      run: docker compose -f docker-compose-prod.yml up -d

    - name: Permission on all scripts
      run: chmod +x ./scripts/*.sh

    - name: Apply Database Migrations to the Docker Container
      run: ./scripts/apply-migration-to-database.sh
    
    - name: Change Workspace Directory
      run: cd tests/e2e

    - name: Install Node Dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    